<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Baromètre Public</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2553488319378463" crossorigin="anonymous"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    form { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .candidate { margin: 6px 0; }
    label { margin-left: 4px; cursor: pointer; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    #result { margin-top: 20px; }
    .vote-item { background: #eee; margin: 5px 0; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; }
    .disclaimer { font-size: 0.9em; margin-top: 10px; color: #666; }
  </style>
</head>
<body>

  <h1>Baromètre Public</h1>
  <p id="instruction">Si l’élection présidentielle avait lieu aujourd’hui, pour qui voteriez‑vous&nbsp;?</p>
  
  <form id="voteForm">
    <!-- Liste Simplifiée pour l'exemple, garde tes candidats ici -->
    <div class="candidate"><input type="radio" name="candidate" id="philippe" value="Édouard Philippe"><label for="philippe">Édouard Philippe</label></div>
    <div class="candidate"><input type="radio" name="candidate" id="attal" value="Gabriel Attal"><label for="attal">Gabriel Attal</label></div>
    <div class="candidate"><input type="radio" name="candidate" id="lepen" value="Marine Le Pen"><label for="lepen">Marine Le Pen</label></div>
    <div class="candidate"><input type="radio" name="candidate" id="melenchon" value="Jean-Luc Mélenchon"><label for="melenchon">Jean-Luc Mélenchon</label></div>
    <div class="candidate"><input type="radio" name="candidate" id="blanc" value="Vote blanc"><label for="blanc">Vote blanc</label></div>

    <button type="button" id="voteButton">Valider mon vote</button>
  </form>

  <div id="result"></div>
  
  <!-- Bouton de secours pour TOI (pour tester) -->
  <button onclick="resetMyVote()" style="margin-top:50px; background:none; color:gray; font-size:10px; border:1px solid #ccc;">Réinitialiser mon vote (Test uniquement)</button>

  <script>
    const SUPABASE_URL = "https://twdemyzpdeelatouccz.supabase.co";
    const SUPABASE_KEY = "sb_publishable_s2WGwh1hX88XYRokc4E01w_axS9n7ad";

    const voteForm = document.getElementById("voteForm");
    const voteButton = document.getElementById("voteButton");
    const resultDiv = document.getElementById("result");

    // 1. AU CHARGEMENT
    window.onload = () => {
      if (localStorage.getItem("hasVoted") === "true") {
        afficherDejaVote();
      }
      chargerResultats();
    };

    // 2. BOUTON VALIDER
    voteButton.addEventListener("click", async () => {
      const selected = document.querySelector('input[name="candidate"]:checked');
      
      if (!selected) {
        alert("Veuillez sélectionner un candidat.");
        return;
      }

      // Désactiver pour éviter le double clic
      voteButton.disabled = true;
      voteButton.textContent = "Enregistrement...";

      const success = await envoyerVote(selected.value);

      if (success) {
        localStorage.setItem("hasVoted", "true");
        afficherDejaVote();
        chargerResultats();
      } else {
        voteButton.disabled = false;
        voteButton.textContent = "Valider mon vote";
      }
    });

    async function envoyerVote(candidateName) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ candidate: candidateName })
        });

        if (response.ok) return true;
        
        const err = await response.json();
        alert("Erreur base de données : " + err.message);
        return false;
      } catch (e) {
        alert("Erreur de connexion.");
        return false;
      }
    }

    async function chargerResultats() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/votes?select=candidate`, {
          headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
        });
        const data = await res.json();
        
        const counts = {};
        data.forEach(v => counts[v.candidate] = (counts[v.candidate] || 0) + 1);

        let html = "<h3>Résultats actuels</h3>";
        Object.entries(counts).sort((a,b) => b[1] - a[1]).forEach(([name, count]) => {
          html += `<div class="vote-item"><span>${name}</span> <span>${count} voix</span></div>`;
        });
        resultDiv.innerHTML = html;
      } catch (e) {
        console.error("Erreur résultats:", e);
      }
    }

    function afficherDejaVote() {
      voteForm.style.display = "none";
      document.getElementById("instruction").innerHTML = "<strong>Merci ! Votre vote a été pris en compte.</strong>";
    }

    // FONCTION POUR QUE TU PUISSES RE-VOTER PENDANT TES TESTS
    function resetMyVote() {
      localStorage.removeItem("hasVoted");
      location.reload();
    }
  </script>
</body>
</html>
